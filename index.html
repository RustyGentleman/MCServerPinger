<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MC Server Pinger</title>
	<style>
		@import url(https://fonts.googleapis.com/css2?family=VT323&display=swap);
		:root {
			font-size: 1.2rem;
			overflow-x: hidden;
		}
		body {
			padding: 0;
			margin: 0;
			background-color: #111;
			color: #ccc;
			max-height: 100vh;
			width: 100vw;
			display: flex;
			justify-content: center;
			font-family: 'VT323', monospace;
			overflow-y: auto;
			padding-bottom: 15vh;
			> div {
				min-width: 400px;
				max-width: calc(100vw - 2rem);
				display: flex;
				flex-direction: column;
				gap: .7rem;
				margin-top: 25vh;
				> * {
					padding: .7rem;
					background-color: #222;
					border-radius: .5rem;
				}
				#header {
					display: block;
					background-color: transparent;
					text-align: center;
					margin-bottom: 1rem;
					padding: 0;
					h1 {
						font-size: 2rem;
						margin: 0;
					}
					small {
						font-size: 1rem;
						opacity: .7;
						a {color: inherit}
					}
					.info {
						margin-top: 1rem;
					}
				}
				#ui {
					position: relative;
					display: flex;
					gap: .5rem;
					input, button {
						border: solid 1px #333;
					}
					#ip, #start, #interval {
						appearance: none;
						background-color: #111;
						padding: .3rem .5rem;
						font-family: inherit;
						color: inherit;
						font-size: inherit;
					}
					#ip {width: 100%}
					#interval {width: 5ch}
					#start {
						background-color: #333;
						cursor: pointer;
						&:hover {
							background-color: #444;
						}
					}
					&::before {
						content: '';
						position: absolute;
						inset: 0;
						top: 50%;
						z-index: -1;
						background-color: #191919;
						border: solid 1px #222;
						border-width: 0 1px;
					}
				}
				#options {
					display: flex;
					margin-top: -.7rem;
					padding: .1rem .3rem;
					border: solid 1px #222;
					border-top: none;
					border-radius: 0 0 .5rem .5rem;
					background-color: #191919;
					font-size: .8em;
					label {display: flex}
				}
				> .server {
					position: relative;
					.info-panel {
						display: grid;
						grid-template-columns: 5rem auto;
						gap: 0 .5rem;
						margin-bottom: .5rem;
						.icon {
							height: 5rem;
							width: 5rem;
							grid-column: 1;
							grid-row: 1 / 5;
							img {
								height: 100%;
								width: 100%;
							}
						}
						.name, .ip, .status-players, .players {grid-column: 2}
						.name {
							font-weight: bold;
							font-size: 1.5rem;
						}
						.ip {opacity: .7}
						.status-players {
							display: flex;
							gap: 0 .5rem;
							.status {
								position: relative;
								margin-left: 1lh;
								&::before {
									content: '';
									position: absolute;
									left: -1lh;
									top: 2px;
									box-sizing: border-box;
									width: .8lh;
									height: .8lh;
									border: solid 3px;
									border-radius: 100%;
								}
								&.online::before {
									background-color: #0c0;
									border-color: #0f0;
								}
								&.offline::before {
									background-color: #c11;
									border-color: #700;
								}
							}
						}
						.players {
							display: flex;
							flex-wrap: wrap;
							flex-direction: row;
							gap: .3rem;
							margin-top: .2rem;
						}
					}
					details {
						max-height: 15lh;
						overflow-y: auto;
						&.pings {
							:not(summary) {padding-inline: .5rem}
							details > div {
								padding-left: 1rem;
								display: flex;
								justify-content: space-between;
								> :first-child {font-weight: bold}
							}
							span > details[open] {
								display: flex;
								flex-direction: column;
								align-items: flex-end;
							}
						}
						&.player-activity {
							.in {color: #0c0}
							.out {color: #c11}
							.phead {border: solid 1px;}
							> div:nth-of-type(2n) {background-color: #333;}
							> div {
								display: grid;
								grid-template-columns: 1fr auto;
								div {grid-row: 1}
								.timestamp {
									display: flex;
									align-items: center;
									opacity: .7;
									grid-column: 2;
									padding-inline: .5rem;
								}
								.timestamp + div {
									display: flex;
									flex-wrap: wrap;
									gap: .3rem;
									text-align: left;
								}
							}
						}
					}
					.close {
						display: flex;
						align-items: center;
						height: 1ch;
						width: 1ch;
						position: absolute;
						top: .5rem;
						right: .5rem;
						cursor: pointer;
					}
				}
			}
			.player {
				img {
					height: 2ch;
					width: 2ch;
				}
				.pname {
					border: solid 1px;
					border-radius: .3rem;
					padding: 0 .2rem;
				}
			}
			&.pheads {
				.player {
					.pname {display: none}
				}
			}
			&:not(.pheads) {
				.player {
					.phead {display: none}
				}
			}
		}
		@keyframes spin {
			0% {transform: rotate(0deg)}
			100% {transform: rotate(360deg)}
		}
		.spin {animation: spin 2s cubic-bezier(0.28, -0.22, 0.22, 1.29)}
	</style>
	<script>
		const watchers = new Map()
		window.addEventListener('load', () => {
			const IP = document.getElementById('ip')
			const START = document.getElementById('start')
			const INTERVAL = document.getElementById('interval')
			const WRAPPER = document.body.firstElementChild

			if (window.localStorage.getItem('pheads') === 'true') {
				document.body.classList.add('pheads')
				document.getElementById('option-pheads').setAttribute('checked', '')
			} else if (window.localStorage.getItem('pheads') === 'false') {
				document.body.classList.remove('pheads')
				document.getElementById('option-pheads').removeAttribute('checked')
			}

			START.addEventListener('click', async function() {
				console.log('Starting interval')
				const ip = IP.value
				IP.value = ''

				if (!ip.length || document.getElementById(ip)) return

				const wrapper = document.createElement('div')
				wrapper.className = 'server'
				wrapper.id = ip
				wrapper.innerHTML = `<div class="info-panel">`
					+`<div class="icon"><img/></div>`
					+`<div class="info">`
						+`<div class="name">Awaiting response...</div>`
						+`<div class="ip">${ip}</div>`
						+`<div class="status-players">`
							+`<div class="status">...</div>`
							+`<div class="player-count">?/?</div>`
						+`</div>`
						+`<div class="players"></div>`
						+`</div>`
					+`</div>`
					+`<div class="close" onclick="Kill(this.parentElement)">x</div>`
					+`<details class="pings"><summary>Ping responses</summary></details>`
					+`<details class="player-activity"><summary>Player activity</summary></details>`
				WRAPPER.append(wrapper)

				createEntry(ip, await fetchInfo(ip))
				watchers.set(ip, setInterval(async () => createEntry(ip, await fetchInfo(ip)), 60000 * INTERVAL.value))
			})

			async function fetchInfo(ip) {
				console.log('Fetching')
				let response
				let info
				await fetch(`https://api.mcsrvstat.us/2/${ip}`)
					.then(res => {
						response = res
						// if (!res.ok) throw new Error("Network response was not ok")
						return res.json()
					})
					.then(data => info = data)
					.catch(err => info = err)
				console.log('Response:\n', response)
				console.log('Server info:\n',info)
				console.log('Fetch end')
				return {response, info}
			}
			function createEntry(ip, data) {
				const {response, info} = data
				const listing = document.getElementById(ip)
				if (info?.icon)
					listing.querySelector('.icon').firstElementChild.src = info?.icon
				listing.querySelector('.name').textContent = info?.motd?.clean
				const lastOnline = Array.from(listing.querySelector('.players').children?? []).reduce((prev, cur) => {
					prev[cur.textContent] = cur.querySelector('img').src.match(/\/([^\/]*)$/)[1]
					return prev
				}, {})
				if (info?.online) {
					listing.querySelector('.status').textContent = 'Online'
					listing.querySelector('.status').classList.add('online')
					listing.querySelector('.status').classList.remove('offline')
					listing.querySelector('.player-count').textContent = `${info?.players?.online}/${info?.players?.max}`
					listing.querySelector('.players').innerHTML = ''
					if (info?.players?.uuid)
						for (const [player, uuid] of Object.entries(info?.players?.uuid))
							listing.querySelector('.players').innerHTML += `<div class="player" title="${player}"><img class="phead" src="https://mc-heads.net/avatar/${uuid}"/><span class="pname">${player}</span></div>`
				} else {
					listing.querySelector('.status').textContent = 'Offline'
					listing.querySelector('.status').classList.add('offline')
					listing.querySelector('.status').classList.remove('online')
					listing.querySelector('.player-count').textContent = `?/?`
					listing.querySelector('.players').textContent = ''
				}

				//* Ping response entry
				const wrapperPingEntry = document.createElement('div')
				const entry = document.createElement('details')
				const summary = document.createElement('summary')
				const date = new Date(Date.now())
				const timestamp = [[
						`${date.getDate()}`.padStart(2, '0'),
						`${date.getMonth()+1}`.padStart(2, '0'),
						date.getFullYear(),
					].join('/'), [
						`${date.getHours()}`.padStart(2, '0'),
						`${date.getMinutes()}`.padStart(2, '0'),
						`${date.getSeconds()}`.padStart(2, '0'),
					].join(':')
				].join(', ')
				const timeShort = [
					`${date.getHours()}`.padStart(2, '0'),
					`${date.getMinutes()}`.padStart(2, '0'),
				].join(':')

				summary.innerHTML = timestamp
				entry.append(summary)

				if (info?.online == true) {
					addValue('Online', info?.online)
					addValue('Version', info?.version)
					addValue('Players', info?.players?.online? `<details><summary>${info?.players?.online}/${info?.players?.max}</summary>${info?.players?.list?.join(', ')}</details>` : `${info?.players?.online}/${info?.players?.max}`)
				} else {
					addValue('Online', info?.online)
					addValue('Error', `${info?.debug?.error?.ping}`)
				}

				listing.querySelector('details.pings').append(entry)

				if (info?.online == false)
					return

				//* Player activity approximation
				const activity = listing.querySelector('details.player-activity')
				const online = info?.players?.uuid || {}
				// const loggedOut = Array.from(new Set(lastOnline).difference(new Set(online)))
				const loggedOut = Object.entries(lastOnline)
					.filter(([username]) => !(username in online))
					.reduce((prev, [username, uuid]) => {
						prev[username] = uuid
						return prev
					}, {})
				const loggedIn = Object.entries(online)
					.filter(([username]) => !(username in lastOnline))
					.reduce((prev, [username, uuid]) => {
						prev[username] = uuid
						return prev
					}, {})
				const wrapperActivityEntry = document.createElement('div')
				const wrapperPlayers = document.createElement('div')

				console.log('Last online: ', lastOnline)
				console.log('Online: ', online)
				console.log('Logged in: ', loggedIn)
				console.log('Logged out: ', loggedOut)

				wrapperActivityEntry.innerHTML = `<div class="timestamp" title="${timestamp}">${timeShort}</div>`
				wrapperActivityEntry.append(wrapperPlayers)

				for (const [player, uuid] of Object.entries(loggedOut))
					wrapperPlayers.innerHTML += `<div class="player out" title="${player}"><img class="phead" src="https://mc-heads.net/avatar/${uuid}"/><span class="pname">${player}</span></div>`
				for (const [player, uuid] of Object.entries(loggedIn))
					wrapperPlayers.innerHTML += `<div class="player in" title="${player}"><img class="phead" src="https://mc-heads.net/avatar/${uuid}"/><span class="pname">${player}</span></div>`

				if ((Object.keys(loggedOut).length + Object.keys(loggedIn).length) > 0)
					activity.append(wrapperActivityEntry)

				function addValue(label, value) {
					const wrapper = document.createElement('div')
					const elabel = document.createElement('span')
					const evalue = document.createElement('span')
					elabel.innerHTML = label+':'
					evalue.innerHTML = value
					wrapper.append(elabel, evalue)
					entry.append(wrapper)
				}
			}
		})
		function Kill(server) {
			clearInterval(watchers.get(server.id))
			server.remove()
			watchers.delete(server.id)
		}
		function TogglePlayerHeads() {
			document.body.classList.toggle('pheads')
			window.localStorage.setItem('pheads', document.body.classList.contains('pheads'))
		}

		//# Key combos
		{
			let typed = ''
			let timeoutID
			const combos = [
				{trigger: 'spin', callback: () => {
					document.querySelectorAll('div').forEach(async e => {
						e.classList.add('spin')
						await new Promise(r => setTimeout(r, 2100))
						e.classList.remove('spin')
					})
				}},
			]

			document.addEventListener('keydown', (e) => {
				if (e.key?.length === 1 && e.key?.match(/\w{1}/)) {
					typed += e.key.toLowerCase()
					console.log(typed)
					for (const combo of combos)
						if (typed === combo.trigger) {
							combo.callback()
							typed = ''
						}
				}
				if (timeoutID) clearTimeout(timeoutID)
				timeoutID = setTimeout(() => {
					typed = ''
					timeoutID = undefined
				}, 1000)
			})
		}
	</script>
</head>
<body class="pheads">
	<div>
		<div id="header">
			<h1>MC Server Pinger</h1>
			<small>Made by <a href="https://github.com/RustyGentleman"><img src="https://mc-heads.net/avatar/e6440362-a1a9-4cbf-a807-b4132cddbdca" style="height:1lh;transform:translateY(.2lh)">Rasutei</a></small>
			<br>
			<div class="info">
				A small utility for pinging Minecraft servers for information<br>
				such as MOTD, version, player count and player names<br>
				on a configurable interval (in minutes).
			</div>
		</div>
		<div id="ui">
			<input type="text" name="ip" id="ip" placeholder="Minecraft server IP" title="Server IP">
			<input type="number" name="interval" id="interval" value="10" min="1" step="1" title="Interval (minutes)">
			<button id="start">Start</button>
		</div>
		<div id="options">
			<label>
				<input type="checkbox" id="option-pheads" checked onclick="TogglePlayerHeads()">
				Player heads
			</label>
		</div>
	</div>
</body>
</html>